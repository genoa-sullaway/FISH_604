---
title: "Hwk 3 Genoa Sullaway"
output:
  word_document:
    toc: yes
    toc_depth: '2'
---


# TO DO -- FIGUURE OUT FIGURE SIZES IN RMD, NEED  TO BE  BIGGER
# HYPOTHESES COULD BE BETTER?
# FIGURE LABEL #S AND REFERENCE THEM IN TEXT
# MAKE  SURE REFERENCES ARE SET UP RIGHT
# ANY OTHER PLOTS?
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(here)
library(tidyverse)
library(sf)
library(maps)
library(raster)
library(corrplot)
theme_set(theme_classic())

```

```{r LOAD DATA}
#load data that was created by : final_DF_EDA_StatsProj.R
df <- read_csv(here("data","fulldata_stats_proj.csv")) 

```

```{r create base maps shape file,include=FALSE}
#create base map
ak <- sf::st_as_sf(maps::map('world','USA:Alaska',
                             # ylim = c(55,60),
                             #   xlim=c(-140,-130), 
                             plot=FALSE, fill=TRUE))

#create bounds to trim AK map 
bounds_ak <- extent(-176,-150,50,66 )
#bounds_ak <- extent(-164.5,-160, 55,60) 
extent_ak <- st_set_crs(st_as_sf(as(bounds_ak, "SpatialPolygons")), 4326)
ak <- st_intersection(ak, extent_ak) #trim map by intersections 
 plot(ak)
 
#load shape file with ortiz shapes 
# ortiz_shp <- st_read("data/ortiz_regions/BSIERP_regions_2012.shp")
# ortiz_shp <- subset(ortiz_shp, !DOMAIN == 15)
# #Tranform into WGS84 coordinate system
# ortiz_shp <- st_transform(ortiz_shp, "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")

```

## Preliminary Title: 
Evaluating Spatial Variance in *Calanus marshallae* distribution during the 2014-2106 Marine Heatwave in the Eastern Bering Sea

## Introduction/Background
Marine heatwaves (MHW) have become more prevalent as anthropogenic climate change impacts progress (Frolicher et  al 2018). In  the Northeast Pacific Ocean, the most recent MHW (2014-2016) resulted in mass mortalities  and marine mammal strandings, species distribution shifts, fishery closures and social-ecological network shifts (Cheng and Frolicher 2020, Fisher et al 2021). 

Primary and secondary production are tightly linked to oceanographic conditions. In the E. Bering Sea, copepods such as *Calanus spp*, underpin the health of the entire ecosystem. As high nutrient prey items, Calanus support marine mammals, numerous subsistence fisheries and a billion-dollar Pollock fishery. However, copepod abundance and community composition are heavily regulated by environmental factors. During cold years, large nutritious copepods are abundant and persist throughout the season to feed age-0 pollock in Fall. However, during warm years, the zooplankton community composition transitions to smaller less nutritious species and large copepods are often absent on the inner shelf in Fall when pollock are preparing to overwinter (Kimmel et al 2018). This disruption in lipid-rich prey in warm years has negative cascading effects throughout the EBS food web and social ecological networks. 

  If Calanus spatial heterogeneity exists within warm years, this could provide spatial refuges for predators where they still have access to high quality prey items. On the other hand, large scale climate events can lead to increases in spatial synchrony across increasingly large distances. A large spread marine heatwave may increase synchrony in Calanus abundance across the EBS, and this can have cascading negative effects through the ecosystem. Moreover, changes to spatial variability in Calanus within warm years can have implications for future predator-prey overlap (Siddon et al 2013). 

## Goals and Objectives

The research question I would like to address is: Is there spatial variation in Calanus abundance during the 2014-2016 Marine Heatwave in the Eastern Bering Sea?  

Warm stanzas and marine heatwaves are predicted to become more common in the EBS. I want to understand the spatial variability for Calanus among warm years, to ultimately inform the spatial availability of Calanus prey for higher trophic levels. Does the EBS become a "food desert" for higher trophic levels or are there certain spatial refuges during warm years? 

Generally, copepod abundance and phenology are tightly linked to oceanographic conditions. Thus, I expect variation in temperature to be a strong predictor in C. marshallae CPUE. With greater temperatures resulting in less Calanus. I expect there may be effects related to years since the onset of the marine heatwave, ie I expect 2014 to be different than 2016 because of cumulative impacts of warm years. I expect *Calanus* to be more abundance in the northern inner shelves compared to the southern and outer shelves because of past *Calanus* research demonstrating higher abudnance on inner shelves, additionally, temperatures in the Norther regions were slightly cooler than the south and I expect this to contribute to *Calanus* spatial variation. 

I will need to test for colinearity across covariates, I may not need all the covariates I propose. For example, depth, temperature and Ortiz region may be confounded since Ortiz regions were delineated based on oceanographic bounds and shelf breaks that differ by depth and temperature. 

-wind? salinity?
talk about  mutlicoollinearity

## Data Description

Data were collected by NOAA AFSC ECOFOCI during at-sea oceanographic cruises in the Eastern Bering Sea (Figuure XX) and zooplankton data were provided to GS by Dr. Dave Kimmel. These  data are part of a larger zooplankton community dataset from the eastern Bering Sea. The response variable is *Calanus marshallae* catch per unit effort (CPUE) (individuals m^3) for each station (each point in figure XX) sampled in each year. 

Zooplankton data are collected annually on NOAA oceanographic cruises from April-September, however the spatial and temporal schedule is unbalanced from year to year (Figure XX). Copepods are collected using paired bongo nets (20cm frame, 150um mesh and a 60cm frame, 333 um mesh) on oblique tows. The tow depth varies by station and is not necessarily related to bottom depth. If bottom depth is less than 100m, max tow depth is 5-10m above the bottom. However, if max bottom depth is deeper than 100m the max gear depth can vary depending on the sea state, most tows are not deeper than 300m. The samples are identified to lowest taxonomic level and sorted into different stages (C-1 to C-6), however at this point, I summed Calanus CPUE across lifestages. 

Some covariate data is collected onboard the ship, for example maximum bottom depth and gear depth are recorded on the zooplankton gear deployment. Salinity and temperature covariates were collected from CTD casts done in parallel to zooplankton net casts. Covariates such as wind stress and cold pool extent were downloaded from publicly available climate dataset provided by Dr. Mike Litzlow (NOAA AFSC, https://github.com/mikelitzow/bold-new-pollock/tree/master/data). 

Exploratory data analysis demonstrate that there is unbalanced sampling of stations across years (Figure XX). A coplot of select covariates indicate possible relationships between depth salinity and temperature. We see that there is more variation in temperature and salinity at shallower depths across years. Additionally, there is generally less variation in temperature at depth, which is expected based on the differences in water mixing. Interestingly, it appears that temperatures at depth get warmer and have less variability from 2014 to 2016 (Figure XX). 

```{r PLOT ALL DATA, fig.width=14, fig.height=8 }
 #plot abundances for each station/time point. Color by Domain. 
df_summary<- df %>%
  group_by(YEAR, LAT, LON) %>%
  summarise(sum = sum(EST_NUM_PERM3))

ggplot(ak) +
  geom_sf() +
  geom_point(data = df_summary, aes(x=LON, y=LAT, color = log(sum))) + #, size = EST_NUM_PERM3))+
  theme_classic() +
  scale_color_gradient(low = "#de9b71", high = "#5d74a5", name = "Log C. marshallae CPUE") +
 # guides(color=guide_legend(title="Log(CPUE)")) + 
  theme( 
        plot.caption = element_text(hjust = 0),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  facet_wrap(~YEAR) +
  labs(caption = "A point indicates a station where a survey was conducted,\n each facet represents a year, color indicates the log CPUE for calanus marshallae for each station in each  year")

```

```{r PLOT TEMPERATURE,fig.width=14, fig.height=8}

ggplot(ak) +
  geom_sf() +
  geom_point(data = df, aes(x=LON, y=LAT, color = TEMPERATURE)) + #, size = EST_NUM_PERM3))+
  theme_classic() +
  scale_color_gradient(low = "blue", high = "red", name = "Log C. marshallae CPUE") +
 # guides(color=guide_legend(title="Log(CPUE)")) + 
  theme( 
        plot.caption = element_text(hjust = 0),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  facet_wrap(~YEAR) +
  labs(caption = "A point indicates a station where a survey was conducted,\n each facet represents a year, color indicates the mean temperature at each station in each  year")

```


```{r plot coplot depth SST and salinity}
#remove one salinity outlier 
df_no_sal <- df %>%
  filter(!SALINITY<23 )

coplot(SALINITY~TEMPERATURE|MAX_GEAR_DEPTH * as.factor(YEAR), data = df_no_sal, number=c(4,3))
mysubtitle = "Figure XX. Coplot demonstrating the\nrelationship between temperature, \nsalnity, maximum gear depth and year from\n stations where zooplankton were surveyed"
mtext(side=3, line= -28, at=-0.2, adj=0, cex=0.7, mysubtitle)

```

```{r }
df %>%
  ggplot() +
  geom_histogram(aes(log(EST_NUM_PERM3)))+
  labs(caption = "Figure  XX. Log-transformed CPUE for the complete  Calanus  marshallae dataset")

```

## Methods
- These data may have spatial autocorrelation and they may have a slight right skew. However, with a log transformation (Figure XX) data appear normal, so I will use a log normal distribution with a log link for the model.  

- The random  variable we want to predict is Calanus CPUE where $\gamma_i$ = Calanus m-3
  

$$log(\gamma_{i,s,y}) \sim LogNormal(\mu_{i,s,y},\sigma^2) $$

$$log(\mu_{s,y})= B_{0s} + B_1Depth_{s,y} + B_2Temp_{s,y} + B_3SAL_{s,y} + B_4Wind_{n,y} + B_5CP_y + B_6Domain_s + B_7SAL_{s,y}+ \varepsilon$$
$$\varepsilon = MVN(0,\sigma)$$

Where $B_{0i}$ is the random effect of year (note I am interested in looking at temporal autocorrelation, I think the order of the year matters as the heatwave progresses), $Depth_{s,y}$  is the survey depth, $Temp_{s,y}$ is the mean temperature at each station for each year, $SAL_{s,y}$ is the mean salinity at each station  for each year, $Wind_{n,y}$ is the wind stress for each direction (north or south) for each year, $CP_y$ is the cold pool  extent for that year, $Domain_s$ is the station domain related to the Ortiz regions delineated by oceanographic bounds. The error term, $\varepsilon_i$, is assumed to be multivariate normally distributed and $\sigma$ will be composed of a variance-covariance matrix that accounts for spatial autocorrelation.

Back-transformed results will under go a bias correction.
 
- W = wind (north and south) for each year (y) DECIDE  WHICH WIND  METRIC TO  USE

## References
- Cheung, W.W.L., Frölicher, T.L. Marine heatwaves exacerbate climate change impacts for fisheries in the northeast Pacific. Sci Rep 10, 6678 (2020). https://doi.org/10.1038/s41598-020-63650-z
- Frölicher, Thomas L., Erich M. Fischer, and Nicolas Gruber. "Marine heatwaves under global warming." Nature 560.7718 (2018): 360-364.
- Fisher, Mary C., Stephanie K. Moore, Sunny L. Jardine, James R. Watson, and Jameal F. Samhouri. "Climate shock effects and mediation in fisheries." Proceedings of the National Academy of Sciences 118, no. 2 (2021).
- Siddon, Elizabeth Calvert, Trond Kristiansen, Franz J. Mueter, Kirstin K. Holsman, Ron A. Heintz, and Edward V. Farley. "Spatial match-mismatch between juvenile fish and prey provides a mechanism for recruitment variability across contrasting climate conditions in the eastern Bering Sea." PLoS One 8, no. 12 (2013): e84526.