---
title: "Stats_Project_RmD"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)


#create full data frame for stats project

# library(ncdf4)
# library(ncdf4.helpers)
# library(PCICt)
library(here)
library(tidyverse)
library(sf)
library(maps)
library(raster)
library(corrplot)
theme_set(theme_classic())
#load data that was created by : final_DF_EDA_StatsProj.R
df <- read_csv(here("data","fulldata_stats_proj.csv")) #created this DF on 9/14/2021, saved it so I dont have to keep running this script
 
```

```{r online resources, include=FALSE}
#this one has good spatial data info and how to do Morans
#https://rspatial.org/raster/analysis/3-spauto.html

```


```{r create base maps shape file,include=FALSE}
#create base map
ak <- sf::st_as_sf(maps::map('world','USA:Alaska',
                             # ylim = c(55,60),
                             #   xlim=c(-140,-130), 
                             plot=FALSE, fill=TRUE))

#create bounds to trim AK map 
bounds_ak <- extent(-176,-150,50,66 )
#bounds_ak <- extent(-164.5,-160, 55,60) 
extent_ak <- st_set_crs(st_as_sf(as(bounds_ak, "SpatialPolygons")), 4326)
ak <- st_intersection(ak, extent_ak) #trim map by intersections 
 plot(ak)
 
#load shape file with ortiz shapes 
ortiz_shp <- st_read("data/ortiz_regions/BSIERP_regions_2012.shp")
ortiz_shp <- subset(ortiz_shp, !DOMAIN == 15)
#Tranform into WGS84 coordinate system
ortiz_shp <- st_transform(ortiz_shp, "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs")

```

## Problem Statement
How does spatial covariance in Calanus abundance vary within warm years in the Eastern Bering Sea (EBS)? 

-  Motivation: Warm years are predicted to become more common in EBS. I want to understand the spatial variability for Calanus among warm years, to ultimately inform the spatial availability of Calanus prey for higher trophic levels. Does the EBS become a "food desert" for higher trophic levels or are there certain spatial refuges during warm years? 

## Data
- Calanus abundance at each station in the EBS, spatially and temporally unbalanced sampling
- Spatial temporal dataset from ECOFOCI NOAA AFSC 
- Temporal focus on recent Marine Heatwave (2014-2016)
- Spatial extent is the Eastern Bering sea, I have aggregated data into Ortiz Regions
- Covariates:
- SST ERSST (used a nearest neighbor approach to assign monthly mean and Jan-April SST anomoly into Ortiz regions)
- Ice-free days since March 15
- Wind
- Should get Cholorphyll A (haven't done this yet!)

## Current Questions 
- How to deal with spatial temporal unbalanced sampling? 
- My covariates have different spatial breadth, is this an issue? I am not sure how to deal with that. 
- Suggestions for EDA for spatial component of dataset... Moran Index? 

## Stats Approach
- Data are not independent and data have unequal variances, they are heavily right skewed, gamma distribution under predicts high values. 
- The random  variable we want to predict is $\gamma_i$ = Calanus m-3
- What is underlying distribution?  Data are  >-0, continuous, and overdispersed...current best guess is Gamma? log link, these are apparently hard to fit. 

$$\gamma_i \sim Gamma(\mu_i,v) $$ 
$$log(\mu_i)= intercept+ B_1Depth_{s,y}+B_2MSST_{d,y}+B_3Anom_{d,y}+B_4Wind_{n,y}+B_5CP_y+B_6Year_{y-1} +B_7Domain_s + \varepsilon_i$$ 
- Subscript i represents each individual sample/station (?) should the subscript here instead be d because I am interested in Calanus within each domain/ortiz region.

- Depth = bottom depth at survey station (s) and year (y)

- MSST = mean SST for  each ortiz region (d) and year (y)

- Anom = anomSST from Jan-April for each ortiz region (d)

- W = wind (north and south) for each year (y)

- CP = cold pool extent for each year

- Year = year -- Is this where I put in the temoporal autocorrelation? 

- Domain - for each station (s) (?), this represents assigning each station into larger Ortiz regions -- I am not sure how to deal with this term? Do I need to add more stuff to represent this spatial component or is that covered in the error term? 

$$\varepsilon_i = MVN(0,\sigma)$$ 

- Define spatial correlation structure within $\sigma$ 

- Define shape parameter ($v$), here  I can allow a lot of right skew? Need to explore this part more... 

$$v \sim gamma(0.01,0.01) $$ 

### First plot all the data
- Below is each station x survey month and year, this is helpful and works to understand where I do and do not have data. 
- Months 5 (but not in 2015) and 9 (all three years) have the best spatial coverage. I think I may break into early and late season? Do I want to pool these at all? 
- There is coordinate weirdness in Domain 15 because it crosses the dateline, need to investigate this <-- currently I just removed it. 

```{r}
 #plot abundances for each station/time point. Color by Domain. 
ggplot(ak) +
  geom_sf() +
  geom_point(data = df, aes(x=LON, y=LAT, color = as.character(DOMAIN))) + #, size = EST_NUM_PERM3))+
  theme_classic() +
  theme(legend.position = "none",
        plot.caption = element_text(hjust = 0),
        axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank(),
        axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  facet_grid(YEAR~MONTH) +
  labs(caption = "A point indicates a station where a survey was conducted,\nrows are year columns are month, colors refer to different Ortiz Regions that\ndata were assigned to")

#plot(rgamma(1000,shape = 0.01, scale = 0.1))
```

### Plot Histogram of Calanus Abundance Across whole dataset
- High right skew, these arent 0's they are numbers between 0 and 1
```{r}
ggplot(data =df) +
geom_histogram(aes(EST_NUM_PERM3))
```

-With transformations it is still super skewed and over dispersed data. 
```{r}
ggplot(data =df) +
geom_histogram(aes(EST_NUM_PERM3^1/4)) +
  labs(caption =  "Cube Root Transform")

ggplot(data =df) +
geom_histogram(aes(log(EST_NUM_PERM3))) +
  labs(caption =  "Log Transform")
```

- What does it look like if I log  transform?   

-This is kinda normal? I think? 
```{r, eval=FALSE}
df %>%
  filter(!EST_NUM_PERM3==0) %>%
  ggplot() +
  geom_histogram(aes(EST_NUM_PERM3)) +
    labs(caption =  "Positive Catch Only ")

test<-df %>%
  filter(!EST_NUM_PERM3==0) %>%
  ggplot() +
  geom_histogram(aes(log(EST_NUM_PERM3))) +
    labs(caption =  "Positive Catch Only, Log Transform")
```

### Now look at the mean Calanus abundance spatially for each year, just to get an idea of spatial variation
- Looks like there is some spatial variation in calanus abundance depending on the year. 
```{r}
df_sum <- df %>%
  group_by(DOMAIN, YEAR) %>%
  summarise(mean_zoop  = mean(EST_NUM_PERM3)) 
class(df_sum)
#can  i left join this to the  ortiz shape? 
#st_join()
join<- left_join(ortiz_shp,df_sum )

#class(join)
 ggplot() +
    # geom_sf(data = df_sum, aes(fill = mean_zoop), color = "white")+ #color = "black", fill = "white") +
     geom_sf(data=ak) +
     geom_sf(data = join, aes(fill = mean_zoop)) + #color = "black", fill = "white") +
     facet_wrap(~YEAR) +
     scale_fill_gradient(low = "darkgreen", high = "yellow") +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
```

### Now look at the mean Calanus abundance spatially for each month/year, 
- I like this plot because it shows where we have data for each domain in each month/year
```{r}
df_month <- df %>%
   group_by(DOMAIN, YEAR, MONTH) %>%
   summarise(mean_zoop  = mean(EST_NUM_PERM3)) 
 
#can  i left join this to the  ortiz shape? 
#st_join()
join_month<- left_join(ortiz_shp,df_month )

#now look by year and month
#this plot is super helpfulf or a few reasons. We can see where we have domain info for each  month/year, 
#so do I want to group this data seasonally with in a  year? or maybe I  start off ignoring month so I can get full  spatial  dataset
ggplot() +
   geom_sf(data=ak) +
   geom_sf(data = join_month, aes(fill = mean_zoop)) + #color = "black", fill = "white") +
   facet_grid(YEAR~MONTH) +
   scale_fill_gradient(low = "darkgreen", high = "yellow") +
   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) 
 
#what types of plots can  I make to look at equal variances and independence in spatial data??

  
#also how to calculate a dsitance  matrix between domains, may be useful later   
#   #The centroids:
#   shp_centroid <- st_point_on_surface(x = shp_irak01)
# 
# #The euclidian distance matrix:
# mtx_distance <- st_distance(shp_centroid, shp_centroid)
# mtx_distance

```

- What does coverage look like if I group early/late season?  Still less coverage early in the year... 
- Is there no sampling early on the east side because of sea ice? But then sea ice disappears 2015-2016 so they could sample? 

```{r}
df_season <- df %>%
   mutate(SEASON = case_when(MONTH %in% c(3,4,5,6) ~ "EARLY",
                             TRUE ~ "LATE")) %>%
   ungroup() %>%
   group_by(DOMAIN, YEAR, SEASON) %>%
   summarise(mean_zoop  = mean(EST_NUM_PERM3)) 
 
join_season<- left_join(ortiz_shp,df_season )

ggplot() +
   geom_sf(data=ak) +
   geom_sf(data = join_season, aes(fill = mean_zoop)) + #color = "black", fill = "white") +
   facet_grid(YEAR~SEASON) +
   scale_fill_gradient(low = "darkgreen", high = "yellow")
 
```
 
## Check for Normality
- Super duper not normal 
```{r}
# Check for normality:
x<-sort(df$EST_NUM_PERM3)
qqnorm(x)     
qqline(x, col=2, lwd=2)

```


-What about log-normal? .... It looks way better. 
```{r}
qqnorm(log(x))		# log-normal fits better, but not too good!
qqline(log(x), col=2, lwd=2)
```

- Positive right skew data ... gamma distribution? 
```{r}
library(MASS)
fit <- fitdistr(df$EST_NUM_PERM3, "gamma")
fit  # Note the two estimated parameters of the gamma distribution

```
 
 
### Fit to Gamma Dist 
- The data are still much larger than expected if you were to fit a gamma distribution
```{r}
# Construct q-q plot:
# Check for normality:
x<-sort(df$EST_NUM_PERM3)
f.i <- ((1:length(x))-0.5)/length(x)
#  gamma quantiles corresponding to f_i
q.i <- qgamma(f.i, shape = coef(fit)["shape"], rate = coef(fit)["rate"])
plot(q.i, x, pch=16, xlab = "Theoretical quantiles", ylab = "Sample quantiles")
# Line through 10th and 90th quantiles (the default for q-q plots in R):
x1 <- qgamma(c(0.1, 0.9), shape = coef(fit)["shape"], rate = coef(fit)["rate"])
x2 <- quantile(x,c(0.1,0.9))

abline(lm(x2~x1))  # quick way to add straight line that goes through these points

```
 
- What about if I cube-root transform data? 
- It doesnt really help that much, still under predicting data in gamma dist. 
```{r cube root QQ plot }

x<-sort(df$EST_NUM_PERM3^1/4)
f.i <- ((1:length(x))-0.5)/length(x)
#  gamma quantiles corresponding to f_i
q.i <- qgamma(f.i, shape = coef(fit)["shape"], rate = coef(fit)["rate"])
plot(q.i, x, pch=16, xlab = "Theoretical quantiles", ylab = "Sample quantiles")
# Line through 10th and 90th quantiles (the default for q-q plots in R):
x1 <- qgamma(c(0.1, 0.9), shape = coef(fit)["shape"], rate = coef(fit)["rate"])
x2 <- quantile(x,c(0.1,0.9))

abline(lm(x2~x1))  # quick way to add straight line that goes through these points

```

## Variances
- Plot using time series faceted by domains
- Looks like data have unequal variances, also it is a time series so we expect some temporal autocorrelation
- Need to do boxcox test for transformation, 4th root? 
- Plot by year.month with a free y axis. 

```{r}
# 
# df %>%
#   ggplot() +
#     geom_boxplot(aes(x=as.character(YEAR), y = EST_NUM_PERM3)) + 
#     facet_wrap(~DOMAIN, scales = "free")
# 
# df %>%
#   group_by(YEAR, DOMAIN) %>%
#   mutate(est_cube_rt = EST_NUM_PERM3^1/4 ) %>%
#   summarise(mean = mean(est_cube_rt), sd = sd(est_cube_rt)) %>%
#     ggplot(aes(x=as.character(YEAR), y = mean)) +
#       geom_point( ) + 
#       geom_errorbar(aes(ymin = mean-sd, ymax = mean+sd ), width = 0.1) +
#       facet_wrap(~DOMAIN)#, scales = "free")
    

df %>%
  mutate(MONTH = str_pad(MONTH, 2, pad = "0")) %>%
  tidyr::unite(YEAR, MONTH, col= "year.month",  sep = ".") %>%
  mutate(year.month=as.numeric(year.month)) %>%
  arrange(year.month) %>%
  group_by(year.month, DOMAIN) %>%
  mutate(year.month = as.character(year.month) ) %>%
  summarise(mean = mean(EST_NUM_PERM3), sd = sd(EST_NUM_PERM3)) %>%
    ggplot(aes(x=year.month, y = mean)) +
      geom_point( ) + 
      geom_errorbar(aes(ymin = mean-sd, ymax = mean+sd ), width = 0.1) +
      facet_wrap(~DOMAIN, scales = "free_y") +
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
      ylab("Mean Calanus abundance")

```

- Look at data cube-root transformed
```{r}
df %>%
  mutate(MONTH = str_pad(MONTH, 2, pad = "0")) %>%
  tidyr::unite(YEAR, MONTH, col= "year.month",  sep = ".") %>%
  mutate(year.month=as.numeric(year.month)) %>%
  arrange(year.month) %>%
  group_by(year.month, DOMAIN) %>%
  mutate(est_cube_rt = EST_NUM_PERM3^1/4, year.month = as.character(year.month) ) %>%
  summarise(mean = mean(est_cube_rt), sd = sd(est_cube_rt)) %>%
    ggplot(aes(x=year.month, y = mean)) +
      geom_point( ) + 
      geom_errorbar(aes(ymin = mean-sd, ymax = mean+sd), width = 0.1) +
      facet_wrap(~DOMAIN, scales = "free_y") +
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
      ylab("Mean Calanus abundance  (data cube root  transform)")
```

##  Temporal Correlation
```{r}
#use this to plot temporal autocorrelation, need to arrange the data by time beforey you do this. 
auto_corr<-df %>%
  mutate(MONTH = str_pad(MONTH, 2, pad = "0")) %>%
  tidyr::unite(YEAR, MONTH, col= "year.month",  sep = ".") %>%
  mutate(year.month=as.numeric(year.month)) %>%
  arrange(year.month)

```

```{r, eval=FALSE}
#PLOT AUTOCORR OF UNSORTED DATA 
acf(df$EST_NUM_PERM3)
```

- Plot ACF of sorted data (sorted by year.month) 
- There is significant termporal autcorrelation through the whole time series... also looks like a slight periodic lag? 
```{r}
acf(auto_corr$EST_NUM_PERM3)
```

## Spatial Correlation
- I think I need to do this differently using the Moran index... 
```{r}
#look at correlation among domains within each year - create a correlation matrix. 
#first justplot one year: 
corr_2014<- df %>%
  filter(YEAR == 2014) %>%
  group_by(MONTH, DOMAIN)  %>%
  summarise(EST_NUM_PERM3=mean(EST_NUM_PERM3)) %>%
  spread(key=DOMAIN, value =EST_NUM_PERM3 ) %>%
  as.matrix()

corr_df<- df %>%
  group_by(YEAR, DOMAIN)  %>%
  summarise(EST_NUM_PERM3=mean(EST_NUM_PERM3)) %>%
  spread(key=DOMAIN, value =EST_NUM_PERM3 ) %>%
  dplyr::select_if(~ !any(is.na(.))) %>%
  ungroup() %>%
  dplyr::select(-YEAR) %>%
  as.matrix() 
  
corr_mat<-cor(corr_df)

corrplot(corr_mat, method = "circle")
```

```{r code to createa distance matrix, eval=FALSE}
#I think I willwant this later? 
#also how to calculate a dsitance  matrix between domains, may be useful later   
#   #The centroids:
#   shp_centroid <- st_point_on_surface(x = shp_irak01)
# 
# #The euclidian distance matrix:
# mtx_distance <- st_distance(shp_centroid, shp_centroid)
# mtx_distance

```

## Visualize the covariates
- First lets do temperature
- What to do about Priblofs since there is no temp data that goes there and it is a relative small area... I could force the nearest neighbor to approximate and assign temp that way?

```{r}
ggplot(data = df) +
  geom_point(aes(x=as.character(YEAR), y=mean_temp, color = MONTH)) +
  facet_wrap(~name)+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme_classic()
```

- Plot the mean temperatures across the  dataset
- Note that covariates have been matched with the  zooplankton dataset, so blanks here are because of no data in zoop dataset not in the covariate dataset.  

```{r}
ggplot(ak) +
  geom_sf() +
  geom_point(data = df, aes(x=LON, y=LAT, color =mean_temp))+
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(YEAR~MONTH)+
  scale_colour_gradient(low = "blue", high = "red") +
  labs(caption = "Mean montly SST")
```

- There isn't a lot of  variation in the mean monthly temperatures but there is variation in the Jan - April anomoly depending  on the region you are in:
```{r}
ggplot(ak) +
  geom_sf() +
  geom_point(data = df, aes(x=LON, y=LAT, color =mean_temp_anom_JanApril))+
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_wrap(~YEAR) +
  scale_colour_gradient(low = "blue", high = "red") +
  labs(caption = "Jan-April SST anomly")
```

