---
title: "Hwk 2 - Genoa  Sullaway"
output:
  html_document:
    df_print: paged
    toc: true # table of content true
    toc_depth: 2   
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(here)
theme_set(theme_classic())
```

# Sullaway - FISH 604
# Homework 2 script file

```{r, echo = FALSE}
############ Prob. 1: Data import 
sable <- read.csv("data/sablefish.csv", as.is=F)
# head(sable)	      # Look at first few rows
# hist(sable$Age)   # Age composition
# table(sable$Age)  # Same in table format
# summary(sable)    # Basic summary of each variable
# is.factor(sable$Sex)
```

## Problem 1

1A. Question: Explore length distribution by plotting histograms or density plots of the length of sablefish overall and by sex.

Answer:

```{r 1A }
# SABLEFISH histogram overall:
ggplot() +
  geom_histogram(data = sable, aes( x=Length)) +
  ggtitle("Sablefish Length Distribution Overall")

                 
#sablefish histogram by sex:
ggplot() +
  geom_histogram(data = sable, aes( x=Length, group = Sex, fill = Sex)) +
  ggtitle("Sablefish Length Distribution By Sex (1)")

ggplot() +
  geom_histogram(data = sable, aes( x=Length, group = Sex, fill = Sex)) +
  facet_wrap(~Sex) +
  ggtitle("Sablefish Length Distribution By Sex (2)")
 
```

1B Question: Are there obvious differences in the length distribution between males and females?

Answer:
- Yes, it looks like male lengths are generally smaller than females in this dataset. There is also more variability and greater breadth in female length.

## Problem 2

2A. Question: 

Plot length (on y-axis) versus age, weight vs. age, and weight vs. length of all fishes using different symbols or colors for males and females.

Answer:

```{r 2a}
ggplot(data = sable, aes(x=Age, y = Length))+
  geom_point(aes(color = Sex), alpha = 0.5) +
  geom_jitter(aes(color = Sex)) +
  geom_smooth(aes(color=Sex), method="loess", level=0.95) +
    labs(caption = "Length versus age for male and female sablefish")
  
ggplot(data = sable, aes(x=Age, y = Length))+
  geom_point(aes(color = Sex), alpha = 0.5) +
  geom_jitter(aes(color = Sex)) +
  geom_smooth(aes(color=Sex), method="loess", level=0.95) +
  facet_wrap(~Year, nrow =1) +
  labs(caption = "Length at age by year, for male and female sablefish")
  
ggplot(data = sable, aes(x=Age, y = Weight))+
  geom_point(aes(color = Sex), alpha = 0.5) +
  geom_jitter(aes(color = Sex)) +
 geom_smooth(aes(color=Sex), method="loess", level=0.95) +
    labs(caption = "Weight versus age for male and female sablefish")

ggplot(data = sable, aes(x=Age, y = Weight))+
  geom_point(aes(color = Sex), alpha = 0.5) +
  geom_jitter(aes(color = Sex)) +
  geom_smooth(aes(color=Sex), method="loess", level=0.95) +
  labs(caption = "Weight versus age for male and female sablefish among years")  +
  facet_wrap(~Year, nrow =1)
  
ggplot(data = sable, aes(x=Length, y = Weight, group = Sex, color = Sex))+
  geom_point( alpha = 0.5) +
  geom_jitter(aes(color = Sex))+
  geom_smooth() +
    labs(caption = "Weight versus length for male and female sablefish")

ggplot(data = sable, aes(x=Length, y = Weight, group = Sex, color = Sex))+
  geom_point( alpha = 0.5) +
  geom_jitter(aes(color = Sex))+
  geom_smooth() +
    labs(caption = "Weight versus length for male and female sablefish among years") +
  facet_wrap(~Year, nrow =1)
 
```

2B. Question: Does there appear to be an asymptotic length and/or weight for males and females? Does there appear to be a difference in growth between males and females? Are there apparent differences in the length-weight relationship among years?

Answer:

- Yes there appears to be an asymptotic length for both sexes, though it is more apparent for females. Qualitatively, asymptotic length looks different between males and females, female length appears to level off around 800 and males length appears to level off around 700. There also appears to be an asymptotic weight for females, females asymptote at a higher weight, a little less than 8. The asymptotic relationship for males is less apparent and a little greater than 4.

- Based on the weight by age and length by age plots, it looks like females grow faster than males, because weights and lengths are greater for younger females than for young males. 

- There  is slight variation  in the length-weight relationship among years, for example in 2006 there are some male fish that weight less than we would expect based on their length.  

## Problem 3

3A Question: 

Based on the previous graphical analyses (disregarding sexes, i.e. we fit the model to both sexes combined) and the interpretation of the parameters in the model, choose reasonable starting values for L∞ and a0 and justify your choice! Use 0.05 for the growth parameter k.

Answer: 

I chose Linf = 900 and  a0 = -10, I decided on these values based on visualizing the data and seeing where the length data appeared to asymptote, I realized that a0 would have to be negative because fish are not born at age 0  with length = 0 . 

```{r  problem  3a}
# LvB growth model function to compute predicted values:
LvB <- function(a, k, L.inf, a0) {
  L.inf*(1-exp(-k*(a-a0)))
}

# Try out some starting values and superimpose on scatterplot:
ST <- c(k = 0.05, L.inf = 900 , a0 = -10) 
# Make sure to pick sensible values for L.inf and a0, then add line:
plot(jitter(Length) ~ jitter(Age), data=sable, col=2)
lines(1:80, LvB(1:80, k = ST[1], L.inf = ST[2], a0 = ST[3]), lwd=3)

# Fit the model using 'nls()' with the regression equation
# 'nls' finds parameters that minimize the sum of squared
# differences between the left-hand side (observed lengths)
# and the right-hand side (predicted lengths) of the formula
fit <- nls(Length ~ LvB(Age, k, L.inf, a0), data = sable, start = ST)
#summary(fit)
#coef(fit)


  
```


3B Question:

Use these coefficients to compute predicted values over a range of length values and add a fitted line to the scatterplot.

Answer:
```{r 3b plot the fit}
# Visualize the overall model fit
# plot(jitter(Length) ~ jitter(Age), data=sable, col=2)
 cf <- coef(fit)

sable$prednls = predict(fit)
 
ggplot(data = sable, aes(x=Age, y = Length))+
  geom_point(alpha = 0.1 ) +
  geom_jitter( ) +
  geom_line(aes(y=prednls), color  = "red") +
  labs(caption = "Length versus age for sablefish,  with NLS fitted line")
```

3C  Question:

Construct a 95% confidence interval for the overall growth parameter (k) and for the estimated mean length at infinity (Linf). 
Answer:

```{r 3C}
#summary(fit)$coef[1,2] #row  1 column 2
#mean est K  0.08285995

#easier way to get CI's 
ci_fit <- confint(fit, level = 0.95)

#Growth parameter:
cat("95% of the time the growth parameter K will be between", (ci_fit[1,1]), "to",(ci_fit[1,2]), " ")


#mean est  Linf = 769
#estimated mean length at infinity
cat("95% of the time the estimated mean length at infinity (Linf) will be between",( ci_fit[2,1]), "to",  (ci_fit[2,2]), "  ")

```

## Problem 4


4A Question: Plot the distribution of the residuals as histograms and boxplots (overall, by year, by sex).

Answer:

```{r 4a }
sable$r <- resid(fit) #extract residuals

ggplot(data=sable) +
  geom_histogram(aes(x = r)) +
  labs(caption  =  "Figure 4a.1: Histogram of overall residuals, box is surrounding the 25th and 75th percentiles, middle line represents the mean")

ggplot(data=sable) +
  geom_boxplot(aes(y= r)) +
  labs(caption  =  "Figure 4a.2: Boxplot  of overall residuals, box is surrounding the 25th and 75th percentiles, middle line represents the mean")

ggplot(data=sable) +
  geom_boxplot(aes(y = r,group= Age, color=  Age)) +
  geom_hline(aes(yintercept=0), color= "red") +
  labs(caption  =  "Figure 4a.3: plot  of residuals by Age,  box is surrounding the 25th and 75th percentiles, middle line represents the mean")

ggplot(data=sable) +
  geom_boxplot(aes(y = r,group= Sex, color=  Sex)) +
  geom_hline(aes(yintercept=0), color= "red") +
  labs(caption  =  "Figure 4a.4: Boxplot  of residuals by Sex, box is surrounding the 25th and 75th percentiles, middle line represents the mean")

ggplot(data=sable) +
  geom_boxplot(aes(y = r,group= Year)) +
  geom_hline(aes(yintercept=0), color= "red") +
  labs(caption  =  "Figure 4a.5: Boxplot  of residuals by Year ")
```

4B Question: Examine these plots and based on a graphical examination only, briefly discuss the assumptions that residuals (for the combined model) are normally distributed and that they are identically distributed (with age, across years and between sexes)! Show one or two representative plots to illustrate your conclusion(s).

Answer: 

The residuals for the combined model are fairly normally distributed. They have a slight right skew (Figure 4a.1 and 4a.2, and  qqplot below) but I don't think this is a huge violation of normality. However, when we look at residuals across age, years and sexes not all of the residuals are identically distributed. For example, residuals are not identical across sex, male residuals differ from female (Figure  4a.4). Residuals are also not identical for age, residuals become much more variable for older fish and very young fish (Figure  4a.3). Residuals do look fairly identical by year, 2002 is a little low but the 25-75th percentiles still cross 0 for  all years.

```{r}
qqnorm(sable$Length)
qqline(sable$Length, col=2)
```

 
4C Question: If you find that any of the regression assumptions are violated, what might be a good approach to dealing with it in this case?

Answer: I think there are a few ways to address this, we could 1) transform the data using a box-cox transform to see if that changed residuals, 2) create two different models, one for males and one for females. We could also consider a model that allows for unequal variances, such as Weighted Least Squares Regression.


## Problem 5

Repeat the analysis of growth separately for males and for females for a single year of your choice (avoid 2006, as it may be problematic).

- Results for Male NLS, just 2003.

```{r}
# going to use 2003

#MALE 
male_sable<- sable %>% 
      filter(Year == 2003) %>% 
       filter(Sex == "Male")
male_fit <- nls(Length ~ LvB(Age, k, L.inf, a0), data = male_sable, start = ST)

summary(male_fit)
coef(male_fit)

```

- Results for Female NLS 2003

```{r}

#FEMALE 
 female_sable<- sable %>% 
      filter(Year == 2003) %>% 
      filter(Sex == "Female")
                         
female_fit <- nls(Length ~ LvB(Age, k, L.inf, a0), data = female_sable, start = ST)

summary(female_fit)
coef(female_fit)

```


5A Question: Show plots of male and female length-at-age with the fitted lines (you can plot them separately or in a single panel using any tools in your toolkit)


Answer: Plots below. 


```{r}
female_sable$prednls = predict(female_fit)
ggplot(data = female_sable, aes(x=Age, y = Length))+
  geom_point(alpha = 0.1, color = "grey") +
  geom_jitter( ) +
  geom_line(aes(y=prednls), color  = "pink") +
  #geom_smooth(  method="loess", level=0.95) +
  labs(caption = "Length versus age for female sablefish, with NLS fitted line")

male_sable$prednls = predict(male_fit)
ggplot(data = male_sable, aes(x=Age, y = Length))+
  geom_point(alpha = 0.1,color = "grey") +
  geom_jitter( ) +
  geom_line(aes(y=prednls), color  = "blue") +
  #geom_smooth(  method="loess", level=0.95) +
  labs(caption = "Length versus age for male sablefish, with NLS fitted line")

```

5B Question: Summarize the parameter estimates and their standard errors for males and females and
compute approximate 95% confidence intervals for the growth parameters by sex.

Answer:

- Parameter estimates and 95% CI for females:

```{r}
# parameters: k, L.inf, a0
#parameters and standard errors: 
# component of the summary output, for example:
summary(female_fit)$coef
# This is a matrix from which you can simply extract values, for example by name:
#summary(female_fit)$coef["k","Std. Error"]
confint(female_fit, level = 0.95)

```

- Parameter estimates and 95% CI for males:

```{r}
summary(male_fit)$coef
confint(male_fit, level = 0.95)
```

- Parameter estimates and  SE's are summarized in the plot below: 

```{r}
#plot K for male and female 
m_df<-summary(male_fit)$coef
m_df <- data.frame(m_df)
m_df$param <- rownames(m_df)
m_df$sex <- "M"

df<-summary(female_fit)$coef
df <- data.frame(df)
df$param <- rownames(df)

test <- df %>%
  mutate(sex = "F") %>%
 rbind(m_df)

# Plot them 
ggplot(data = test,aes(x=sex, y = Estimate, group = sex, color = sex)) +
  geom_point() +
 scale_color_manual(values=c(  "#E69F00", "#56B4E9"))+
  geom_errorbar(aes(ymin = Estimate-Std..Error, ymax= Estimate + Std..Error)) +
  facet_wrap(~param, scales = "free_y") +
  ggtitle("Parameter estimates (NLS) between male and female sablefish")+
  labs(caption = "point is mean parameter estimates, errorbars are SE from model estimates")

```

```{r}
female_ci <- confint(female_fit, level = 0.95)
male_ci <- confint(male_fit, level = 0.95)

```
 
- Plot Mean parameter estimates with confidence intervals instead of SE 

```{r}

male_ci <- data.frame(male_ci)
male_ci$sex <- "M"
male_ci$param <- rownames(male_ci)

female_ci <- data.frame(female_ci)
female_ci$sex <- "F"
female_ci$param <- rownames(female_ci)

ci_df<-rbind(female_ci,male_ci)

test_ci <- test %>%
  left_join(ci_df)

# Plot them 
ggplot(data = test_ci,
        aes(x=sex, y = Estimate, group = sex, color = sex)) +
  geom_point() +
  scale_color_manual(values=c(  "#E69F00", "#56B4E9"))+
  geom_errorbar(aes(ymin =X2.5. , ymax= X97.5.)) +
  facet_wrap(~param, scales = "free_y") +
  ggtitle("Parameter estimates (NLS) between male and female sablefish (with 95% CI)")+
  labs(caption = "point is mean parameter estimates, errorbars are 95% CI from model estimates")
```


5C and 5D Question:

Statistically test for a difference in the growth parameter k between males (km) and females (kf) using a Wald test by computing the Wald statistic for the difference (kf – km) and test whether it is larger than expected by chance under the null hypothesis that the difference is zero.

Answer: [note-  I vectorized the equation, answers are all on one line]

Wald  Statistic:

```{r}
delta_theta = summary(female_fit)$coef[,"Estimate"]-summary(male_fit)$coef[,"Estimate"]
null_theta=0
#delta_theta_var = (summary(female_fit)$coef[,"Std. Error"])^2-(summary(male_fit)$coef[,"Std. Error"])^2

delta_theta_var = diag(vcov(female_fit))+ diag(vcov(male_fit)) 

W = ((delta_theta-null_theta)^2)/delta_theta_var

W
```

ChiSq  results:

```{r}
pchisq(W, df = 1)
```

5E Question Briefly summarize your conclusions about growth of male and female sablefish.

Answer: 

It appears that in 2003 male sable fish grew slightly faster than females (k parameterestimate for M was 0.05, while it was 0.04 for female). This difference is not "significantly" different among  sexes  based on the chisquared test of the Wald statistic. However, estimates for the maximum asymptote length (Linf) are "significantly" different among  sexes as shown by a large Wald statistic  and a significant chisquared result. Our  model demonstrates that in  2003 females grew larger than males, it just may take  them longer to get to those lengths. 



















